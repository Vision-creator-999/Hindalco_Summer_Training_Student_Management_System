<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 1200px;
        }
        .table-container {
            overflow-x: auto;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
        }
        .message-box button {
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 0.5rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Message box for user notifications -->
    <div id="message-box" class="message-box hidden">
        <p id="message-text"></p>
        <button onclick="document.getElementById('message-box').classList.add('hidden')">OK</button>
    </div>

    <!-- Edit/Delete Modal -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Edit Student</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label for="edit-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="edit-email" disabled class="mt-1 block w-full px-4 py-2 border rounded-lg bg-gray-100">
                </div>
                <div>
                    <label for="edit-firstname" class="block text-sm font-medium text-gray-700">First Name</label>
                    <input type="text" id="edit-firstname" required class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="edit-lastname" class="block text-sm font-medium text-gray-700">Last Name</label>
                    <input type="text" id="edit-lastname" required class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="edit-city" class="block text-sm font-medium text-gray-700">City</label>
                    <input type="text" id="edit-city" required class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="edit-mobile" class="block text-sm font-medium text-gray-700">Mobile No.</label>
                    <input type="tel" id="edit-mobile" required class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label for="edit-training-start" class="block text-sm font-medium text-gray-700">Training Start Date</label>
                    <input type="date" id="edit-training-start" class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="edit-training-end" class="block text-sm font-medium text-gray-700">Training End Date</label>
                    <input type="date" id="edit-training-end" class="mt-1 block w-full px-4 py-2 border rounded-lg">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="closeModalBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
        <button id="logoutBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
            Logout
        </button>
    </header>

    <main class="container mx-auto p-6">
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Student Records</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="searchByTerm" class="sr-only">Search by Term</label>
                    <input type="text" id="searchByTerm" placeholder="Search by name, email, or city..." class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="searchByYearInput" class="sr-only">Search by Year</label>
                    <input type="text" id="searchByYearInput" placeholder="Search by Year (e.g., 2024)" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="sortSelect" class="sr-only">Sort By</label>
                    <select id="sortSelect" class="w-full px-4 py-2 border rounded-lg">
                        <option value="none">Sort By</option>
                        <option value="firstname">Name</option>
                        <option value="city">City</option>
                        <option value="department">Department</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="min-w-full bg-white rounded-lg overflow-hidden shadow">
                    <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <tr>
                            <th class="py-3 px-6 text-left">Name</th>
                            <th class="py-3 px-6 text-left">Email</th>
                            <th class="py-3 px-6 text-left">Mobile</th>
                            <th class="py-3 px-6 text-left">City</th>
                            <th class="py-3 px-6 text-left">Department</th>
                            <th class="py-3 px-6 text-left">Training Start</th>
                            <th class="py-3 px-6 text-left">Training End</th>
                            <th class="py-3 px-6 text-left">Certificate</th
                            <th class="py-3 px-6 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody" class="text-gray-600 text-sm font-light">
                        <!-- Student data will be populated here -->
                    </tbody>
                </table>
            </div>

            <p id="noResultsMessage" class="hidden text-center text-gray-500 mt-4">No students found.</p>
        </section>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
  

        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-n-HYZuNKwuONnhpU88KB9uozlgYXggc",
            authDomain: "hindalco-summer-training.firebaseapp.com",
            projectId: "hindalco-summer-training",
            storageBucket: "hindalco-summer-training.firebasestorage.app",
            messagingSenderId: "509882186806",
            appId: "1:509882186806:web:24f833ec6fe0a2ee2e6c97",
            measurementId: "G-HNX2DF4S2M"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allStudentsData = []; // Store all fetched students for filtering/sorting

        // Display message box
        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.innerText = message;
            messageBox.classList.remove('hidden');
        }

        // Display students in the table
        function displayStudents(students) {
            const tableBody = document.getElementById('studentsTableBody');
            const noResultsMessage = document.getElementById('noResultsMessage');
            tableBody.innerHTML = '';
            if (students.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${student.firstname} ${student.lastname}</td>
                        <td class="py-3 px-6 text-left">${student.email}</td>
                        <td class="py-3 px-6 text-left">${student.mobileno || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${student.city || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${student.department || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${student.trainingStartDate || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${student.trainingEndDate || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">
                        <div class="flex items-center space-x-2">
                            ${student.certificateUrl 
                              ? `<i class="fas fa-check-circle text-green-500"></i>` 
                              : `<i class="fas fa-times-circle text-red-500"></i>`}
                            <input type="file" id="file-${student.id}" class="hidden" 
                                   onchange="uploadCertificate('${student.id}')">
                            <button onclick="document.getElementById('file-${student.id}').click()" 
                                    class="bg-blue-500 text-white px-2 py-1 rounded">Upload</button>
                          </div>
                        </td>
                        <td class="py-3 px-6 text-left">
                            <div class="flex item-center justify-start">
                                <button onclick="openEditModal('${student.id}')" class="w-8 h-8 mr-2 transform hover:text-purple-500 hover:scale-110">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteStudent('${student.id}')" class="w-8 h-8 transform hover:text-red-500 hover:scale-110">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        // Fetch all students from Firestore
        async function fetchStudents() {
            try {
                const studentsCol = collection(db, 'students');
                const studentSnapshot = await getDocs(studentsCol);
                allStudentsData = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayStudents(allStudentsData);
            } catch (error) {
                console.error("Error fetching students:", error);
                showMessage("Failed to fetch student data.");
            }
        }

        // Open edit modal
        function openEditModal(studentId) {
            const student = allStudentsData.find(s => s.id === studentId);
            if (!student) {
                showMessage("Student not found.");
                return;
            }
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('edit-id').value = student.id;
            document.getElementById('edit-email').value = student.email;
            document.getElementById('edit-firstname').value = student.firstname;
            document.getElementById('edit-lastname').value = student.lastname;
            document.getElementById('edit-city').value = student.city;
            document.getElementById('edit-mobile').value = student.mobileno;
            document.getElementById('edit-training-start').value = student.trainingStartDate || '';
            document.getElementById('edit-training-end').value = student.trainingEndDate || '';
        }

        // Close edit modal
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        // Handle form submission for editing
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('edit-id').value;
            const startDate = document.getElementById('edit-training-start').value;
            const endDate = document.getElementById('edit-training-end').value;
            if (startDate && endDate && startDate > endDate) {
                showMessage("End date cannot be before start date.");
                return;
            }
            const updatedData = {
                firstname: document.getElementById('edit-firstname').value,
                lastname: document.getElementById('edit-lastname').value,
                city: document.getElementById('edit-city').value,
                mobileno: document.getElementById('edit-mobile').value,
                trainingStartDate: startDate || null,
                trainingEndDate: endDate || null
            };
            try {
                const studentDoc = doc(db, 'students', studentId);
                await updateDoc(studentDoc, updatedData);
                showMessage("Student data updated successfully!");
                document.getElementById('editModal').classList.add('hidden');
                fetchStudents(); // Refresh the list
            } catch (error) {
                console.error("Error updating document:", error);
                showMessage("Failed to update student data.");
            }
        });

        // Handle student deletion
        async function deleteStudent(studentId) {
            if (confirm("Are you sure you want to delete this student?")) {
                try {
                    const studentDoc = doc(db, 'students', studentId);
                    await deleteDoc(studentDoc);
                    showMessage("Student deleted successfully!");
                    fetchStudents(); // Refresh the list
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showMessage("Failed to delete student.");
                }
            }
        }
        
        // Search functionality
        const searchByTermInput = document.getElementById('searchByTerm');
        searchByTermInput.addEventListener('keyup', () => {
            const searchTerm = searchByTermInput.value.toLowerCase();
            const filteredStudents = allStudentsData.filter(student =>
                (student.firstname && student.firstname.toLowerCase().includes(searchTerm)) ||
                (student.lastname && student.lastname.toLowerCase().includes(searchTerm)) ||
                (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                (student.city && student.city.toLowerCase().includes(searchTerm))
            );
            displayStudents(filteredStudents);
        });

        // Search by year functionality
        const searchByYearInput = document.getElementById('searchByYearInput');
        searchByYearInput.addEventListener('keyup', () => {
            const yearTerm = searchByYearInput.value;
            const filteredStudents = allStudentsData.filter(student =>
                (student.trainingStartDate && student.trainingStartDate.includes(yearTerm)) ||
                (student.trainingEndDate && student.trainingEndDate.includes(yearTerm))
            );
            displayStudents(filteredStudents);
        });

        // Sort functionality
        const sortSelect = document.getElementById('sortSelect');
        sortSelect.addEventListener('change', () => {
            const sortBy = sortSelect.value;
            const sortedStudents = [...allStudentsData].sort((a, b) => {
                if (sortBy === 'firstname') {
                    const nameA = (a.firstname || '') + ' ' + (a.lastname || '');
                    const nameB = (b.firstname || '') + ' ' + (b.lastname || '');
                    return nameA.localeCompare(nameB);
                }
                if (sortBy === 'city') {
                    return (a.city || '').localeCompare(b.city || '');
                }
                if (sortBy === 'department') {
                    return (a.department || '').localeCompare(b.department || '');
                }
                return 0; // No sort
            });
            displayStudents(sortedStudents);
        });
        
        // Logout button click handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("Admin signed out successfully.");
                window.location.href = 'Adminlogin.html';
            }).catch((error) => {
                console.error("Error signing out:", error);
                showMessage("Error logging out. Please try again.");
            });
        });

        // Expose functions to the global scope for event handlers
        window.openEditModal = openEditModal;
        window.deleteStudent = deleteStudent;

        // Check auth state on load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, check if they are an admin
                if (user.email === "admin@example.com") {
                    console.log("Admin logged in successfully.");
                    fetchStudents();
                } else {
                    console.log("User is not admin. Logging out.");
                    signOut(auth);
                    window.location.href = 'Adminlogin.html';
                }
            } else {
                console.log("No user signed in. Redirecting to admin login.");
                window.location.href = 'Adminlogin.html';
            }
        });
        const storage = getStorage(app);

async function uploadCertificate(studentId) {
  const fileInput = document.getElementById(`file-${studentId}`);
  const file = fileInput.files[0];
  if (!file) return alert("No file selected");

  try {
    const storageRef = ref(storage, `certificates/${studentId}/${file.name}`);
    await uploadBytes(storageRef, file);
    const fileUrl = await getDownloadURL(storageRef);

    // Save file URL in Firestore
    const studentDoc = doc(db, 'students', studentId);
    await updateDoc(studentDoc, { certificateUrl: fileUrl });

    showMessage("Certificate uploaded successfully!");
    fetchStudents(); // refresh table
  } catch (err) {
    console.error(err);
    showMessage("Error uploading certificate");
  }
}

window.uploadCertificate = uploadCertificate;

    </script>
</body>
</html>
